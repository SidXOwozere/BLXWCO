<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="height=device-height, initial-scale=1">
   <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com; script-src 'self' 'unsafe-inline' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com; style-src 'self' 'unsafe-inline' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com; connect-src 'self' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com; font-src 'self' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com blob:; child-src 'self' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com blob:; worker-src 'self' https://arweave.net https://*.arweave.net https://nftcdn.sidxo.com blob:;">-->


    <link rel="stylesheet" href="./style.css">
    <link rel="apple-touch-icon" sizes="180x180" href="./apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <title>SidXO BLXWCO</title>
</head>

<body>
    <div id="canvasContainer" style="position: relative; width: 100%; height: 100%;">
        <canvas id="artCanvas" width="100%" height="100%"
            style="position: absolute; top: 0; left: 0; z-index: 1;"></canvas>
        <canvas id="textCanvas" width="100%" height="100%"
            style="position: absolute; top: 0; left: 0; z-index: 2;"></canvas>
        <canvas id="blocksCanvas" width="100%" height="100%"
        style="position: absolute; top: 0; left: 0; z-index: 3;"></canvas>
</div>
<div id="overlay">
    <button id="begin">LOADING <span>BLXWCO...</span></button>
</div>

    <script src="./Tone.js"></script>
    <script src="./seeded.js"></script>
<script defer>
    
    function isSafari() {
            return /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        }
    let fontBlobs = {};
    async function loadFonts(fonts) {
            const fontPromises = Object.entries(fonts).map(async ([name, url]) => {
                const fontFace = new FontFace(name, `url(${url})`);
                await fontFace.load();
                document.fonts.add(fontFace);
                return { name, url };
            });
            return Promise.all(fontPromises);
        }

        window.addEventListener('load', async () => {
            const fonts = {
                xoblk: "./xoBlack.woff2",
                xoxb: "./xoExtraBold.woff2",
                xoend: "./xoend.woff2"
            };

            const loadedFonts = await loadFonts(fonts);

            
            loadedFonts.forEach(({ name, url }) => {
                const fontBlob = new Blob([`@font-face { font-family: ${name}; src: url(${url}); }`], { type: 'font/woff2' });
                /*if(!isSafari()){
                    fontBlobs[name] = fonts[name];
                }else{
                    fontBlobs[name] = URL.createObjectURL(fontBlob);
                }*/
                fontBlobs[name] = fonts[name];
            });
        
const seededRandom = new SeededRandom(getSeedFromURL())
                  , initialArtSeed = seededRandom.random();
                function getRandomCharacter($) {
                    if (9 == $)
                        return .5 > seededRandom.random() ? "✗" : "⚬";
                    let[e,i] = [[19968, 40869], [12353, 12447], [12449, 12543], [33, 126], [161, 255], [1536, 1791], [1872, 1919], [1024, 1279], [1280, 1327]][$];
                    return String.fromCharCode(Math.floor(seededRandom.random() * (i - e + 1)) + e)
                }
                function getaudioPart($) {
                    let e = window.location.search
                      , i = new URLSearchParams(e)
                      , t = i.get($);
                    return null === t ? -1 : parseInt(t)
                }
				function getThreeDayCycle(date = new Date()) {
    const startOfYear = new Date(date.getFullYear(), 0, 1); // January 1st of the current year
    const diffInMs = date - startOfYear; // Difference in milliseconds
    const dayOfYear = Math.floor(diffInMs / (24 * 60 * 60 * 1000)) + 1; // Convert to days and add 1

    // Determine the 3-day cycle
    const cycleDay = ((dayOfYear - 1) % 3) + 1; // Cycle through 1, 2, 3

    // Calculate the hours elapsed since midnight
    const startOfDay = new Date(date.getFullYear(), date.getMonth(), date.getDate(), 0, 0, 0); // Midnight today
    const elapsedHoursToday = Math.floor((date - startOfDay) / (60 * 60 * 1000));

    // Determine the 2-hour interval within the current day
    const twoHourInterval = Math.floor(elapsedHoursToday / 2); // 12 intervals (0–11) in a 24-hour day

    return { twoHourInterval, cycleDay };
}
                class SongGenerator {
                    constructor($, e, i="./") {
                        this.style = $,
                        this.scale = new Scale($,e),
                        this.audioBaseUrl = i,
                        this.patternLength = 16,
                        this.loadedSamplers = 0,
                        this.initialized = !1,
                        this.songParts = [],
                        this.samplesLoaded = !1,
                        this.chordSampleUrls = this.loadChordSamples(),
                        this.chordSampler = this.createSampler(this.chordSampleUrls, "chordSamplesLoaded", "Chord samples loaded and ready to play."),
                        this.bassSampleUrls = this.loadBassSamples(),
                        this.basslineSampler = this.createSampler(this.bassSampleUrls, "bassSamplesLoaded", "Bass samples loaded and ready to play."),
                        this.melodySampleUrls = this.loadPianoSamples(),
                        this.melodySampler = this.createSampler(this.melodySampleUrls, "melodySamplesLoaded", "Piano samples loaded and ready to play."),
                        this.intro = [],
                        this.verse = [],
                        this.chorus = [],
                        this.prechorus = [],
                        this.bridge = [],
                        this.melody1 = [],
                        this.melody2 = [],
                        this.nextMelody = [],
                        this.bassline2 = [],
                        this.nextBassline = [],
                        this.chords1 = [],
                        this.chords2 = [],
                        this.nextChords = [],
                        this.melodyFilter = new Tone.BiquadFilter(2e3,"lowpass").toDestination(),
                        this.bassFilter = new Tone.BiquadFilter(200,"highpass").toDestination(),
                        this.chordFilter = new Tone.BiquadFilter(1e3,"bandpass").toDestination(),
                        this.songPlaying = !1,
                        this.sequenceIndex = 0,
                        this.drumPlayers = {},
                        this.loadDrumKit(),
                        this.songStructures = this.songStructures = [    ["Verse", "Chorus", "Verse", "Chorus", "Bridge", "Chorus"],    ["Verse", "Chorus", "Verse", "Bridge", "Chorus", "Outro"],    ["Intro", "Verse", "Chorus", "Verse", "Chorus", "Outro"],    ["Verse", "PreChorus", "Chorus", "Verse", "Bridge", "Chorus", "Outro"],    ["Intro", "Verse", "Chorus", "Verse", "Bridge", "PreChorus", "Chorus", "Outro"],    ["Intro", "Verse", "Chorus", "Bridge", "Chorus", "Outro"],    ["Intro", "Verse", "Chorus", "Bridge", "PreChorus", "Chorus", "Outro"]],
                        this.song = null
                    }
                    createSampler($, e, i) {
                        return new Tone.Sampler({
                            urls: $,
                            baseUrl: this.audioBaseUrl,
                            release: 1,
                            onload: ()=>{
                                this[e] = !0,
                                this.loadedSamplers++,
                                this.loadedSamplers >= Object.keys(this.drumPlayers).length + 3 && (this.samplesLoaded = !0)
                            }
                            ,
                            onerror($) {}
                        }).toDestination()
                    }
                    loadChordSamples() {
                        let $ = getaudioPart("chord");
                        return -1 == $ && ($ = Math.floor(9 * seededRandom.random())),
                        {
                            C4: `chord${$}.mp3`
                        }
                    }
                    loadBassSamples() {
                        let $ = getaudioPart("bass");
                        return -1 == $ && ($ = Math.floor(9 * seededRandom.random())),
                        {
                            C2: `bass${$}.mp3`
                        }
                    }
                    loadPianoSamples() {
                        let $ = getaudioPart("melody");
                        return -1 == $ && ($ = Math.floor(77 * seededRandom.random())),
                        {
                            C4: `melody${$}.mp3`
                        }
                    }
                    loadDrumKit() {
                        let $ = [{
                            name: "Kit 808",
                            urls: {
                                clap: "clap-808.mp3",
                                crash: "crash-808.mp3",
                                hihat: "hihat-808.mp3",
                                kick: "kick-808.mp3",
                                openhat: "openhat-808.mp3",
                                perc: "perc-808.mp3",
                                snare: "snare-808.mp3",
                                tom: "tom-808.mp3"
                            }
                        }, {
                            name: "Kit Acoustic",
                            urls: {
                                clap: "clap-analog.mp3",
                                crash: "crash-noise.mp3",
                                hihat: "hihat-plain.mp3",
                                kick: "kick-acoustic01.mp3",
                                openhat: "openhat-acoustic01.mp3",
                                perc: "perc-tambo.mp3",
                                snare: "snare-acoustic01.mp3",
                                tom: "tom-acoustic01.mp3"
                            }
                        }, {
                            name: "Kit Fat",
                            urls: {
                                clap: "clap-tape.mp3",
                                crash: "crash-tape.mp3",
                                hihat: "hihat-808.mp3",
                                kick: "kick-big.mp3",
                                openhat: "openhat-tight.mp3",
                                perc: "perc-tambo.mp3",
                                snare: "snare-big.mp3",
                                tom: "tom-chiptune.mp3"
                            }
                        }, {
                            name: "Sid Test",
                            urls: {
                                clap: "clap.mp3",
                                crash: "shake.mp3",
                                hihat: "perc-tribal.mp3",
                                kick: "kick-oldschool.mp3",
                                openhat: "openhihat.mp3",
                                perc: "snap.mp3",
                                snare: "snare.mp3",
                                tom: "pop.mp3"
                            }
                        }, {
                            name: "dub",
                            urls: {
                                clap: "Aclap.mp3",
                                crash: "Aperc.mp3",
                                hihat: "Ahihat.mp3",
                                kick: "Akick.mp3",
                                openhat: "Aopenhat.mp3",
                                perc: "Aride.mp3",
                                snare: "Asnare.mp3",
                                tom: "Atom.mp3"
                            }
                        }, {
                            name: "dip",
                            urls: {
                                clap: "Bclap.mp3",
                                crash: "Bcrash.mp3",
                                hihat: "Bhihat.mp3",
                                kick: "Bkick.mp3",
                                openhat: "Bhatopen.mp3",
                                perc: "Bperc.mp3",
                                snare: "Bsnare.mp3",
                                tom: "Bperc1.mp3"
                            }
                        }]
                          , e = getaudioPart("drum");
                        -1 == e && (e = Math.floor(seededRandom.random() * $.length));
                        let i = $[e]
                          , t = new Tone.BiquadFilter({
                            type: "peaking",
                            frequency: 440,
                            Q: 1
                        });
                        t.channelCount = 2,
                        t.channelCountMode = "explicit",
                        Object.entries(i.urls).forEach(([$,e])=>{
                            this.drumPlayers[$] = new Tone.Player({
                                url: `${this.audioBaseUrl}${e}`,
                                onload: ()=>{
                                    this.loadedSamplers++,
                                    this.loadedSamplers >= Object.keys(this.drumPlayers).length + 3 && (this.samplesLoaded = !0)
                                }
                            }).connect(t).toDestination()
                        }
                        )
                    }
                   playDrum($, e) {
    try {
        if ($ !== "bpmRange" && this.drumPlayers[$]) {
            this.drumPlayers[$].start(e);
        }
    } catch (error) {
        console.warn(`Failed to play drum: ${$}, Start Time: ${e}`, error);
    }
}

                    convertToToneTiming($) {
                        let e = {
                            "1n": 1,
                            "2n": .5,
                            "4n": .25,
                            "8n": .125,
                            "16n": .0625,
                            "32n": .03125
                        }
                          , i = "4n"
                          , t = 1 / 0;
                        for (let a of ["1n", "2n", "4n", "8n", "16n", "32n"]) {
                            let n = Math.abs($ - e[a]);
                            n < t && (t = n,
                            i = a)
                        }
                        return i
                    }
                    ensureNoteHasOctave($, e="chords") {
                        if ("chords" == e)
                            return $ + "3";
                        let i = {
                            1: .05,
                            2: .35,
                            3: .4,
                            4: .25,
                            5: 0
                        }
                          , t = 0
                          , a = seededRandom.random();
                        for (let n in i)
                            if (a < (t += i[n]))
                                return $ + n;
                        return $ + "4"
                    }
                    scheduleBeats($, e) {
                        let i;
                        i = e || this.scale.generateBeat();
                        let t = 0;
                        Tone.Transport.scheduleRepeat($=>{
                            let e = Math.floor(Tone.Transport.seconds * Tone.Transport.bpm.value / 60 * 4) % this.patternLength;
                            e !== t && (Object.keys(i).forEach(t=>{
                                "x" === i[t][e] && this.playDrum(t, $)
                            }
                            ),
                            t = e)
                        }
                        , "16n", $)
                    }
                    playMelody($, e, i) {
                        if (!this.samplesLoaded || !i || !(i.length > 0))
                            return;
                        this.melody1 = i;
                        let t = 0
                          , a = e
                          , n = $=>{
                            t >= this.melody1.length && (t = 0);
                          let e = this.melody1[t % this.melody1.length];
                            if (e) {
                                let i = e.note + e.octave
                                  , o = e.duration ? e.duration : "8n";
                                this.melodySampler.triggerAttackRelease(i, o, $),
                                a += Tone.Time(o).toSeconds(),
                                Tone.Transport.scheduleOnce(n, a)
                            }
                            t++
                        }
                        ;
                        n(e),
                        this.songPlaying || (this.songPlaying = !0,
                        "started" !== Tone.Transport.state && Tone.Transport.start())
                    }
                    playBassline($, e, i) {
                        if (!this.samplesLoaded)
                            return;
                        i ? this.bassline1 = i : this.bassline1 = this.scale.generateBassline($);
                        let t = 0
                          , a = e
                          , n = $=>{
                            t >= this.bassline1.length && (t = 0);
                            
                          let e = this.bassline1[t % this.bassline1.length];
                            if (e) {
                                let i = e.note + e.octave
                                  , o = e.duration ? e.duration : "8n";
                                this.basslineSampler.triggerAttackRelease(i, o, $),
                                a += Tone.Time(o).toSeconds(),
                                Tone.Transport.scheduleOnce(n, a)
                            }
                            t++
                        }
                        ;
                        n(e),
                        "started" !== Tone.Transport.state && Tone.Transport.start()
                    }
                    getRandomOctave() {
                        return Math.floor(4 * seededRandom.random()) + 2
                    }
                    async initSongParts() {
    if (this.initialized) return;

    const { twoHourInterval, cycleDay } = getThreeDayCycle();
    let mode = this.scale.mode;

    // Day 1: Melody only after two-hour interval 6
    if (cycleDay === 1) {
        if (twoHourInterval >= 6) {
            this.chorus = await this.generateSection(mode);
            this.songParts = [
                { melody: this.chorus.melody, bassline: [], chords: [], beats: {} }
            ];
        } else {
            this.songParts = [];
            return false;
        }
    } 
    // Day 2: Progressively build full song components
    else if (cycleDay === 2) {
        this.songParts = [];

        if (twoHourInterval >= 0) {
            this.chorus = await this.generateSection(mode);
            this.songParts.push({ melody: this.chorus.melody, bassline: [], chords: [], beats: {} });
        }
        if (twoHourInterval >= 3) {
            this.verse = await this.generateSection(mode);
            this.songParts.push({ melody: this.verse.melody, bassline: [], chords: [], beats: {} });
        }
        if (twoHourInterval >= 6) {
            this.prechorus = await this.generateSection(mode);
            this.songParts.push({ melody: this.prechorus.melody, bassline: [], chords: [], beats: {} });
        }
        if (twoHourInterval >= 9) {
            this.bridge = await this.generateSection(mode);
            this.songParts.push({ melody: this.bridge.melody, bassline: [], chords: [], beats: {} });
        }
        if (twoHourInterval >= 10) {
            this.outro = await this.generateSection(mode);
            this.songParts.push({ melody: this.outro.melody, bassline: [], chords: [], beats: {} });
        }
        if (twoHourInterval >= 11) {
            this.intro = await this.generateSection(mode);
            this.songParts.push({ melody: this.intro.melody, bassline: [], chords: [], beats: {} });
        }

        // Add instrumentation as the day progresses
        if (twoHourInterval >= 3) {
            this.songParts.forEach(part => {
                if (!part.bassline.length) part.bassline = this.chorus.bassline;
            });
        }
        if (twoHourInterval >= 6) {
            this.songParts.forEach(part => {
                if (!part.chords.length) part.chords = this.chorus.chords;
            });
        }
        if (twoHourInterval >= 9) {
            this.songParts.forEach(part => {
                if (!Object.keys(part.beats).length) part.beats = this.chorus.beats;
            });
        }
    } 
    // Day 3: Full song structures
    else if (cycleDay === 3) {
        this.verse = await this.generateSection(mode);
        this.chorus = await this.generateSection(mode);
        this.prechorus = await this.generateSection(mode);
        this.bridge = await this.generateSection(mode);
        this.outro = await this.generateSection(mode);
        this.intro = await this.generateSection(mode);

        this.songParts = this.chooseSongStructure();
    }

    // Compile the song from the parts
    this.song = await this.compileSong();
    this.initialized = true;
}


                    chooseSongStructure() {
                        let $ = this.songStructures[Math.floor(seededRandom.random() * this.songStructures.length)];
                        return $.map($=>this[$.toLowerCase()])
                    }
                    generateSection($, e=0) {
                        let i = this.generateChords($)
                        , n = this.scale.generateBeat()
                          , t = this.generateBassline(i, $)
                          , a = this.generateMelody(i, t, $);
                        return {
                            melody: a,
                            beats: n,
                            bassline: t,
                            chords: i
                        }
                    }
                    generateChords($) {
                        let e = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"]
                          , i = []
                          , t = 0;
                        for (; t < 8; ) {
                            let a = .5 > seededRandom.random() ? 4 : 3
                              , n = this.scale.getChordPattern(a)
                              , o = this.scale.getDurationPattern(a)
                              , r = 0;
                            for (let s of n) {
                                let I = this.scale.chordForPattern[`${$}Chords`][s];
                                if (!I)
                                    continue;
                                let l = this.scale.getTransposedScale(e.indexOf(this.scale.key))
                                  , _ = I.map($=>{
                                    let[i,t] = $.match(/([A-G][#b]?)(\d?)/).slice(1, 3);
                                    t = t ? parseInt(t) : 3;
                                    let a = e.indexOf(i);
                                    if (-1 === a)
                                        return;
                                    let n = this.ensureNoteHasOctave(l[a], t, e.indexOf(this.scale.key));
                                    return n
                                }
                                ).filter($=>void 0 !== $);
                                i.push({
                                    notes: _,
                                    duration: this.convertToToneTiming(o[r % o.length])
                                }),
                                r++
                            }
                            t += a <= 4 ? 2 : 4
                        }
                        return i = i.slice(0, 8),
                        i = this.splitDurations(i)
                    }
                    splitDurations($) {
                        let e = [];
                        for (let i of $)
                            if (.5 > seededRandom.random()) {
                                let t = i.duration / 2;
                                e.push({
                                    notes: i.notes,
                                    duration: t
                                }),
                                e.push({
                                    notes: i.notes,
                                    duration: t
                                })
                            } else
                                e.push(i);
                        return e
                    }
                    generateChords($) {
                        let e = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"]
                          , i = []
                          , t = 0;
                        for (; t < 8; ) {
                            let a = .25 > seededRandom.random()
                              , n = [];
                            for (let o of (a && t <= 4 && n.push(this.scale.pickRandomPattern($)),
                            n.push(this.scale.pickRandomPattern($)),
                            n)) {
                                let r = o.length
                                  , s = this.scale.durationsCombinations[3 === r ? "twoBars" : "fourBars"][Math.floor(seededRandom.random() * this.scale.durationsCombinations[3 === r ? "twoBars" : "fourBars"].length)];
                                for (let I = 0; I < o.length; I++) {
                                    let l = o[I]
                                      , _ = this.scale.chordForPattern[`${$}Chords`][l];
                                    if (!_)
                                        continue;
                                    let m = this.scale.getTransposedScale(e.indexOf(this.scale.key))
                                      , h = _.map($=>{
                                        let[i,t] = $.match(/([A-G][#b]?)(\d?)/).slice(1, 3);
                                        t = t ? parseInt(t) : 3;
                                        let a = e.indexOf(i);
                                        if (-1 === a)
                                            return;
                                        let n = this.ensureNoteHasOctave(m[a], t, e.indexOf(this.scale.key));
                                        return n
                                    }
                                    ).filter($=>void 0 !== $);
                                    i.push({
                                        notes: h,
                                        duration: this.convertToToneTiming(s[I % s.length])
                                    })
                                }
                                t += r <= 4 ? 2 : 4
                            }
                        }
                        return i.slice(0, 8)
                    }
                    generateBassline($, e) {
                        let i = [];
                        for (let t of $) {
                            let a = this.scale.bassDurations[2 === t.duration.length ? "twoBars" : "fourBars"][Math.floor(seededRandom.random() * this.scale.bassDurations[2 === t.duration.length ? "twoBars" : "fourBars"].length)];
                            for (let n of a)
                                i.push({
                                    note: this.scale.getBassNoteFromChord(t.notes, e),
                                    duration: n
                                })
                        }
                        return i
                    }
                    generateMelody($, e, i) {
                        let t = [];
                        for (let a of $) {
                            let n = this.scale.melodyDurations[2 === a.duration.length ? "twoBars" : "fourBars"][Math.floor(seededRandom.random() * this.scale.melodyDurations[2 === a.duration.length ? "twoBars" : "fourBars"].length)];
                            for (let o of n)
                                t.push({
                                    note: this.scale.getMelodyNoteFromChord(a.notes, i),
                                    duration: o
                                })
                        }
                        return t
                    }
                    playChords($, e, i) {
                        if (!this.samplesLoaded || !i || !(i.length > 0))
                            return;
                        this.chords1 = i;
                        let t = 0
                          , a = e
                          , n = $=>{
                            t >= this.chords1.length && (t = 0);
                            let e = this.chords1[t % this.chords1.length];
                            if (e && e.notes) {
                                let i = e.notes.map($=>$);
                                if (i.length > 0) {
                                    let o = e.duration ? e.duration : "4n";
                                    this.chordSampler.triggerAttackRelease(i, o, $),
                                    a += Tone.Time(o).toSeconds(),
                                    Tone.Transport.scheduleOnce(n, a)
                                }
                            }
                            t++
                        }
                        ;
                        n(e),
                        "started" !== Tone.Transport.state && Tone.Transport.start()
                    }
                    async compileSong() {
                        let $ = {
                            melody: [],
                            bassline: [],
                            chords: [],
                            beats: {
                                kick: [],
                                snare: [],
                                hihat: [],
                                openhat: [],
                                clap: [],
                                crash: [],
                                perc: [],
                                tom: []
                            }
                        };
                        return this.songParts.forEach(e=>{
                            e && e.melody && e.melody.length > 0 && ($.melody = $.melody.concat(e.melody),
                            Object.keys($.beats).forEach(i=>{
                                e.beats[i] && ($.beats[i] = $.beats[i].concat(e.beats[i]))
                            },
                            $.bassline = $.bassline.concat(e.bassline),
                            $.chords = $.chords.concat(e.chords)
                            ))
                        }
                        ),
                        $
                    }
                    async startMusic() {
                        await this.initSongParts(),
                        this.song && (this.playSong(),
                        Tone.Transport.start())
                    }
                    stopSong() {
                        Tone.Transport.cancel(),
                        this.songPlaying = !1
                    }
                    playSong() {
                        let $ = Tone.now()
                          , e = 0
                          , i = t=>{
                            e >= this.songParts.length && (e = 0);
                            let a = this.songParts[e]
                              , n = this.calculateSectionDuration(a);
                            this.scheduleBeats($, a.beats),
                            this.playChords(a.chords.length, $, a.chords),
                            this.playMelody(a.melody.length, $, a.melody),
                            this.playBassline(a.bassline.length, $, a.bassline),
                            $ += n,
                            Tone.Transport.scheduleOnce(i, $),
                            e++
                        }
                        ;
                        i($),
                        "started" !== Tone.Transport.state && Tone.Transport.start()
                    }
                    calculateSectionDuration($) {
                        let e = {
                            "1n": 1,
                            "2n": 2,
                            "4n": 4,
                            "8n": 8,
                            "16n": 16
                        }
                          , i = Math.max($.melody.length, $.bassline.length, $.chords.length)
                          , t = 0;
                        for (let a = 0; a < i; a++) {
                            let n = $.melody[a]
                              , o = $.bassline[a]
                              , r = $.chords[a];
                            n && (t += 1 / e[n.duration]),
                            o && (t += 1 / e[o.duration]),
                            r && (t += 1 / e[r.duration])
                        }
                        return t
                    }
                }
                class Scale {
                    constructor($) {
                        this.style = $,
                        this.chordForPattern = {
                            majorChords: {
                                I: ["C", "E", "G"],
                                ii: ["D", "F", "A"],
                                iii: ["E", "G", "B"],
                                IV: ["F", "A", "C"],
                                V: ["G", "B", "D"],
                                vi: ["A", "C", "E"],
                                "vii\xb0": ["B", "D", "F"],
                                I6: ["E", "G", "C"],
                                ii7: ["D", "F", "A", "C"],
                                V6: ["B", "D", "G"],
                                V7: ["G", "B", "D", "F"],
                                vi7: ["A", "C", "E", "G"],
                                "I6/4": ["G", "C", "E"],
                                IV7: ["F", "A", "C", "E"],
                                I7: ["C", "E", "G", "B"],
                                VII: ["B", "D", "F"],
                                "V7/ii": ["A", "C#", "E", "G"],
                                "V7/iii": ["B", "Eb", "F#", "A"],
                                "V7/IV": ["C", "E", "G", "Bb"],
                                "V7/V": ["D", "F#", "A", "C"],
                                "V7/vi": ["E", "Ab", "B", "D"]
                            },
                            minorChords: {
                                i: ["C", "Eb", "G"],
                                "ii\xb0": ["D", "F", "Ab"],
                                III: ["Eb", "G", "Bb"],
                                iv: ["F", "Bb", "Eb"],
                                v: ["G", "Bb", "Eb"],
                                VI: ["Ab", "C", "F"],
                                VII: ["Bb", "D", "G"],
                                i7: ["C", "Eb", "G", "Bb"],
                                "ii\xb07": ["D", "F", "Ab", "Bb"],
                                III7: ["Eb", "G", "Bb", "D"],
                                iv7: ["F", "Bb", "Eb", "G"],
                                v7: ["G", "Bb", "Eb", "F"],
                                VI7: ["Ab", "C", "F", "Bb"],
                                VII7: ["Bb", "D", "G", "C"],
                                i6: ["Eb", "G", "C"],
                                "v7/ii": ["D", "F", "Ab", "Bb"],
                                "v7/III": ["Eb", "G", "Bb", "D"],
                                "v7/iv": ["F", "Bb", "Eb", "G"],
                                "v7/V": ["G", "Bb", "Eb", "F"]
                            },
                            mixolydianChords: {
                                I: ["C", "E", "G"],
                                ii: ["D", "F", "A"],
                                "iii\xb0": ["E", "G", "Bb"],
                                IV: ["F", "A", "C"],
                                v: ["G", "Bb", "D"],
                                vi: ["A", "C", "E"],
                                VII: ["Bb", "D", "F"],
                                I7: ["C", "E", "G", "Bb"],
                                ii7: ["D", "F", "A", "C"],
                                "iii\xb07": ["E", "G", "Bb", "D"],
                                IV7: ["F", "A", "C", "E"],
                                v7: ["G", "Bb", "D", "F"],
                                vi7: ["A", "C", "E", "G"],
                                VII7: ["Bb", "D", "F", "A"],
                                I6: ["E", "G", "C"],
                                "v7/ii": ["D", "F", "A", "C"],
                                "v7/iii": ["E", "G", "Bb", "D"],
                                "v7/iv": ["F", "A", "C", "E"],
                                "v7/V": ["G", "Bb", "D", "F"],
                                III: ["E", "G", "Bb"]
                            },
                            dorianChords: {
                                i: ["D", "F", "A"],
                                ii: ["E", "G", "B"],
                                III: ["F", "A", "C"],
                                IV: ["G", "B", "D"],
                                v: ["A", "C", "E"],
                                "vi\xb0": ["B", "D", "F"],
                                VII: ["C", "E", "G"],
                                i7: ["D", "F", "A", "C"],
                                ii7: ["E", "G", "B", "D"],
                                III7: ["F", "A", "C", "E"],
                                IV7: ["G", "B", "D", "F"],
                                v7: ["A", "C", "E", "G"],
                                "vi\xb07": ["B", "D", "F", "A"],
                                VII7: ["C", "E", "G", "B"],
                                i6: ["F", "A", "D"],
                                "v7/ii": ["E", "G", "B", "D"],
                                "v7/III": ["F", "A", "C", "E"],
                                "v7/iv": ["G", "B", "D", "F"],
                                "v7/V": ["A", "C", "E", "G"],
                                VI: ["B", "D", "F#"],
                                iv: ["G", "Bb", "D"],
                                I: ["D", "F#", "A"]
                            },
                            lydianChords: {
                                I: ["C", "E", "G"],
                                II: ["D", "F#", "A"],
                                iii: ["E", "G", "B"],
                                "#iv\xb0": ["F#", "A", "C"],
                                V: ["G", "B", "D"],
                                vi: ["A", "C", "E"],
                                vii: ["B", "D", "F#"],
                                I7: ["C", "E", "G", "B"],
                                II7: ["D", "F#", "A", "C"],
                                iii7: ["E", "G", "B", "D"],
                                "#iv\xb07": ["F#", "A", "C", "E"],
                                V7: ["G", "B", "D", "F#"],
                                vi7: ["A", "C", "E", "G"],
                                vii7: ["B", "D", "F#", "A"],
                                I6: ["E", "G", "C"],
                                "v7/ii": ["D", "F#", "A", "C"],
                                "v7/iii": ["E", "G", "B", "D"],
                                "v7/iv": ["F#", "A", "C", "E"],
                                "v7/V": ["G", "B", "D", "F#"],
                                VII: ["B", "Eb", "F#"],
                                ii: ["Eb", "F#", "Bb"],
                                IV: ["F#", "Bb", "C#"]
                            },
                            phrygianChords: {
                                i: ["C", "Eb", "G"],
                                II: ["C#", "F", "Ab"],
                                III: ["Eb", "G", "Bb"],
                                iv: ["F", "Ab", "C"],
                                "v\xb0": ["G", "Bb", "C#"],
                                VI: ["Ab", "C", "Eb"],
                                vii: ["Bb", "C#", "F"],
                                i7: ["C", "Eb", "G", "Bb"],
                                II7: ["C#", "F", "Ab", "C"],
                                III7: ["Eb", "G", "Bb", "C#"],
                                iv7: ["F", "Ab", "C", "Eb"],
                                "v\xb07": ["G", "Bb", "C#", "F"],
                                VI7: ["Ab", "C", "Eb", "G"],
                                vii7: ["Bb", "C#", "F", "Ab"],
                                i6: ["Eb", "G", "C"],
                                "v7/ii": ["C#", "F", "Ab", "C"],
                                "v7/III": ["Eb", "G", "Bb", "C#"],
                                "v7/iv": ["F", "Ab", "C", "Eb"],
                                "v7/V": ["G", "Bb", "C#", "F"],
                                V: ["G", "Bb", "D"],
                                VII: ["Bb", "D", "F"]
                            },
                            locrianChords: {
                                "i\xb0": ["B", "C#", "F"],
                                II: ["C", "Eb", "F#"],
                                iii: ["C#", "F", "Ab"],
                                iv: ["Eb", "F#", "Bb"],
                                v: ["F", "Ab", "C"],
                                VI: ["F#", "Bb", "C#"],
                                VII: ["Ab", "C", "Eb"],
                                "i\xb07": ["B", "C#", "F", "Ab"],
                                II7: ["C", "Eb", "F#", "Bb"],
                                iii7: ["C#", "F", "Ab", "B"],
                                iv7: ["Eb", "F#", "Bb", "C#"],
                                v7: ["F", "Ab", "C", "Eb"],
                                VI7: ["F#", "Bb", "C#", "F"],
                                VII7: ["Ab", "C", "Eb", "F#"],
                                i6: ["C#", "F", "B"],
                                "v7/ii": ["C", "Eb", "F#", "Bb"],
                                "v7/iii": ["C#", "F", "Ab", "B"],
                                "v7/iv": ["Eb", "F#", "Bb", "C#"],
                                "v7/V": ["F", "Ab", "C", "Eb"],
                                IV: ["Eb", "G", "Bb"],
                                ii: ["C#", "F", "Ab"]
                            }
                        },
                        this.chordPatterns = {
                            major3: [["I", "IV", "V"], ["I", "V", "IV"], ["I", "vi", "IV"], ["I", "IV", "vi"], ["I", "IV", "ii"], ["I", "V", "ii"], ["IV", "V", "I"], ["vi", "IV", "I"], ["IV", "I", "V"], ["vi", "V", "IV"], ["ii", "V", "I"], ["I", "IV", "I"], ["IV", "I", "vi"], ["V", "IV", "I"], ["I", "vi", "V"], ["I", "ii", "V"], ["V", "vi", "IV"], ["vi", "I", "IV"], ["IV", "vi", "V"], ["vi", "IV", "V"]],
                            minor3: [["i", "VII", "VI"], ["i", "iv", "v"], ["i", "VI", "VII"], ["i", "v", "iv"], ["i", "VII", "v"], ["i", "iv", "VI"], ["i", "VI", "v"], ["VII", "VI", "i"], ["i", "v", "VII"], ["iv", "VII", "i"], ["VI", "VII", "i"], ["i", "VII", "iv"], ["VII", "i", "VI"], ["i", "VI", "iv"], ["iv", "v", "i"], ["v", "VII", "i"], ["VII", "v", "i"], ["VI", "iv", "i"], ["iv", "VI", "VII"], ["v", "VI", "VII"]],
                            mixolydian3: [["I", "VII", "IV"], ["I", "v", "IV"], ["I", "IV", "VII"], ["I", "v", "I"], ["I", "IV", "v"], ["I", "VII", "v"], ["I", "VII", "ii"], ["I", "ii", "VII"], ["I", "III", "VII"], ["I", "VII", "III"], ["I", "VII", "vi"], ["I", "vi", "VII"]],
                            dorian3: [["i", "IV", "v"], ["i", "v", "IV"], ["i", "IV", "VII"], ["i", "IV", "i"], ["i", "v", "i"], ["i", "v", "VII"], ["i", "III", "IV"], ["i", "IV", "III"], ["i", "VI", "VII"], ["i", "VII", "VI"], ["i", "iv", "VII"], ["i", "VII", "iv"]],
                            lydian3: [["I", "II", "V"], ["I", "V", "II"], ["I", "V", "I"], ["I", "VII", "V"], ["I", "V", "VII"], ["I", "II", "iii"], ["I", "iii", "II"], ["I", "ii", "V"], ["I", "V", "ii"], ["I", "IV", "V"], ["I", "V", "IV"]],
                            phrygian3: [["i", "II", "v\xb0"], ["i", "II", "III"], ["i", "iv", "II"], ["i", "iv", "III"], ["i", "VI", "III"], ["i", "III", "VI"], ["i", "V", "II"], ["i", "II", "V"], ["i", "III", "VII"], ["i", "VII", "III"]],
                            locrian3: [["i\xb0", "II", "v"], ["i\xb0", "II", "iii"], ["i\xb0", "iv", "II"], ["i\xb0", "iv", "iii"], ["i\xb0", "v", "IV"], ["i\xb0", "IV", "v"], ["i\xb0", "VII", "v"], ["i\xb0", "v", "VII"], ["i\xb0", "ii", "v"], ["i\xb0", "v", "ii"]],
                            major4: [["I", "V", "vi", "IV"], ["I", "IV", "V", "I"], ["vi", "IV", "I", "V"], ["I", "V", "IV"], ["I", "vi", "IV", "V"], ["I", "IV", "I", "V"], ["IV", "I", "V", "vi"], ["I", "IV", "V", "IV"], ["I", "IV", "ii", "V"], ["I", "V", "ii", "IV"], ["vi", "V", "IV", "V"], ["I", "ii", "iii", "IV"], ["IV", "V", "iii", "vi"], ["vi", "V", "IV", "I"], ["I", "IV", "V", "vi"], ["I", "iii", "IV", "V"], ["vi", "IV", "V", "I"], ["ii", "V", "I", "vi"], ["I", "IV", "V", "V7"], ["IV", "V", "I", "vi"]],
                            minor4: [["i", "VII", "VI", "VII"], ["i", "iv", "v", "i"], ["i", "VI", "III", "VII"], ["i", "VII", "VI", "v"], ["i", "iv", "VII", "III"], ["i", "v", "iv", "i"], ["i", "VI", "III", "v"], ["i", "iv", "v", "VII"], ["i", "VII", "III", "VI"], ["i", "VI", "iv", "v"], ["i", "v", "VI", "III"], ["i", "iv", "III", "VI"], ["i", "VI", "VII", "i"], ["i", "iv", "VI", "v"], ["i", "v", "VII", "VI"], ["i", "VII", "VI", "v"], ["i", "VII", "iv", "v"], ["i", "v", "iv", "III"], ["i", "VI", "v", "VII"], ["i", "v", "VI", "VII"]],
                            mixolydian4: [["I", "VII", "IV", "I"], ["I", "v", "IV", "I"], ["I", "IV", "VII", "I"], ["I", "v", "I", "IV"], ["I", "v", "IV", "v"], ["I", "IV", "I", "VII"], ["I", "v", "I", "VII"], ["I", "IV", "v", "IV"], ["I", "v", "IV", "VII"], ["I", "VII", "I", "IV"], ["I", "IV", "VII", "v"], ["I", "VII", "I", "v"], ["I", "v", "IV", "IV"], ["I", "VII", "IV", "v"], ["I", "VII", "v", "I"], ["I", "IV", "v", "I"], ["I", "VII", "IV", "I"]],
                            dorian4: [["i", "IV", "v", "VII"], ["i", "v", "IV", "VII"], ["i", "IV", "VII", "i"], ["i", "v", "IV", "v"], ["i", "IV", "i", "VII"], ["i", "v", "IV", "i"], ["i", "v", "i", "VII"], ["i", "IV", "VII", "IV"], ["i", "v", "IV", "v"], ["i", "IV", "i", "v"], ["i", "v", "VII", "i"], ["i", "IV", "VII", "v"], ["i", "v", "i", "IV"], ["i", "IV", "v", "VII"], ["i", "v", "i", "v"], ["i", "IV", "v", "I"], ["i", "IV", "i", "IV"]],
                            lydian4: [["I", "II", "V", "I"], ["I", "V", "II", "I"], ["I", "II", "V", "II"], ["I", "V", "I", "II"], ["I", "V", "II", "V"], ["I", "II", "V", "II"], ["I", "V", "I", "V"], ["I", "V", "II", "V"], ["I", "II", "V", "II"], ["I", "II", "V", "V"], ["I", "II", "V", "IV"], ["I", "IV", "V", "I"], ["I", "II", "IV", "V"], ["I", "V", "IV", "I"], ["I", "V", "V", "II"], ["I", "II", "IV", "V"]],
                            phrygian4: [["i", "II", "v\xb0", "i"], ["i", "II", "III", "i"], ["i", "iv", "II", "i"], ["i", "II", "v\xb0", "II"], ["i", "iv", "III", "i"], ["i", "II", "v\xb0", "v\xb0"], ["i", "II", "III", "v\xb0"], ["i", "II", "v\xb0", "III"], ["i", "iv", "v\xb0", "i"], ["i", "iv", "II", "v\xb0"], ["i", "iv", "v\xb0", "II"], ["i", "II", "v\xb0", "v\xb0"]],
                            locrian4: [["i\xb0", "II", "v", "i\xb0"], ["i\xb0", "II", "iii", "i\xb0"], ["i\xb0", "iv", "II", "i\xb0"], ["i\xb0", "II", "v", "II"], ["i\xb0", "iv", "iii", "i\xb0"], ["i\xb0", "II", "v", "v"], ["i\xb0", "II", "iii", "v"], ["i\xb0", "iv", "v", "i\xb0"], ["i\xb0", "iv", "ii", "v"], ["i\xb0", "II", "iv", "v"], ["i\xb0", "v", "ii", "iv"], ["i\xb0", "iv", "iii", "ii"]],
                            major5: [["I", "V", "vi", "IV", "I"], ["I", "IV", "V", "I", "V"], ["vi", "IV", "I", "V", "I"], ["I", "V", "IV", "I", "IV"], ["IV", "I", "V", "IV", "I"], ["I", "V", "ii", "IV", "I"], ["vi", "V", "IV", "V", "I"], ["IV", "V", "I", "vi", "IV"], ["I", "vi", "IV", "V", "IV"], ["ii", "V", "I", "vi", "V"], ["I", "IV", "V", "vi", "I"], ["I", "iii", "IV", "V", "I"], ["vi", "IV", "V", "I", "V"], ["ii", "IV", "I", "V", "I"], ["IV", "V", "I", "V", "I"], ["I", "V", "vi", "IV", "V"], ["vi", "V", "IV", "I", "IV"], ["I", "IV", "V", "I", "V7"], ["IV", "V", "I", "IV", "V"], ["I", "IV", "V", "ii", "V"]],
                            minor5: [["i", "VII", "VI", "v", "i"], ["i", "iv", "v", "VII", "i"], ["i", "VI", "VII", "i", "v"], ["i", "VII", "iv", "VI", "v"], ["i", "v", "iv", "VII", "i"], ["i", "VII", "v", "i", "VI"], ["i", "VI", "iv", "v", "i"], ["i", "iv", "VII", "VI", "i"], ["i", "VII", "iv", "v", "i"], ["i", "v", "VII", "VI", "v"], ["i", "VI", "v", "VII", "i"], ["i", "VII", "VI", "iv", "i"], ["i", "iv", "v", "i", "VII"], ["i", "VII", "v", "VI", "iv"], ["i", "v", "iv", "VI", "v"], ["i", "VII", "iv", "VI", "v"], ["i", "v", "VII", "iv", "i"], ["i", "VI", "iv", "v", "VII"], ["i", "iv", "VII", "i", "v"], ["i", "v", "VI", "VII", "i"]],
                            mixolydian5: [["I", "VII", "IV", "v", "I"], ["I", "v", "IV", "VII", "I"], ["I", "IV", "VII", "v", "I"], ["I", "v", "IV", "v", "I"], ["I", "IV", "I", "VII", "I"], ["I", "v", "I", "VII", "I"], ["I", "IV", "v", "IV", "I"], ["I", "VII", "I", "IV", "I"], ["I", "IV", "VII", "I", "v"], ["I", "VII", "I", "v", "I"], ["I", "v", "IV", "IV", "I"], ["I", "VII", "IV", "v", "I"], ["I", "v", "I", "IV", "I"], ["I", "IV", "VII", "IV", "I"], ["I", "VII", "v", "I", "IV"], ["I", "IV", "v", "I", "v"], ["I", "VII", "IV", "I", "IV"], ["I", "v", "I", "IV", "VII"]],
                            dorian5: [["i", "IV", "v", "VII", "III"], ["i", "v", "IV", "VII", "i"], ["i", "IV", "VII", "i", "IV"], ["i", "v", "IV", "v", "VII"], ["i", "IV", "i", "VII", "i"], ["i", "v", "IV", "i", "IV"], ["i", "IV", "v", "VII", "IV"], ["i", "v", "i", "VII", "IV"], ["i", "IV", "VII", "IV", "v"], ["i", "v", "IV", "VII", "IV"], ["i", "IV", "i", "v", "IV"], ["i", "v", "VII", "i", "IV"], ["i", "IV", "VII", "v", "IV"], ["i", "v", "i", "IV", "v"], ["i", "IV", "v", "VII", "III"], ["i", "v", "IV", "v", "III"], ["i", "IV", "v", "VII", "III"], ["i", "v", "i", "v", "IV"]],
                            lydian5: [["I", "II", "V", "I", "II"], ["I", "V", "II", "I", "V"], ["I", "II", "V", "II", "I"], ["I", "V", "I", "II", "V"], ["I", "V", "II", "V", "II"], ["I", "II", "V", "I", "V"], ["I", "V", "I", "V", "II"], ["I", "II", "V", "II", "V"], ["I", "V", "II", "I", "II"], ["I", "II", "V", "I", "II"], ["I", "II", "V", "IV", "II"], ["I", "V", "II", "IV", "I"], ["I", "IV", "V", "I", "II"], ["I", "II", "IV", "V", "II"], ["I", "IV", "V", "II", "I"]],
                            phrygian5: [["i", "II", "v\xb0", "i", "II"], ["i", "II", "III", "i", "II"], ["i", "iv", "II", "i", "II"], ["i", "II", "v\xb0", "II", "i"], ["i", "iv", "III", "i", "II"], ["i", "II", "v\xb0", "v\xb0", "II"], ["i", "II", "III", "v\xb0", "II"], ["i", "II", "v\xb0", "III", "II"], ["i", "iv", "II", "v\xb0", "II"], ["i", "iv", "III", "v\xb0", "II"], ["i", "iv", "v\xb0", "i", "II"]],
                            locrian5: [["i\xb0", "II", "v", "i\xb0", "II"], ["i\xb0", "II", "iii", "i\xb0", "II"], ["i\xb0", "iv", "II", "i\xb0", "II"], ["i\xb0", "II", "v", "II", "i\xb0"], ["i\xb0", "iv", "iii", "i\xb0", "II"], ["i\xb0", "II", "v", "v", "II"], ["i\xb0", "II", "iii", "v", "II"], ["i\xb0", "iv", "v", "i\xb0", "II"], ["i\xb0", "iv", "ii", "v", "II"], ["i\xb0", "II", "iv", "v", "II"], ["i\xb0", "v", "ii", "iv", "II"]]
                        },
                        this.durationsCombinations = {
                            twoBars: [[7 / 16, 9 / 16], [9 / 16, 7 / 16], [6 / 16, .625], [.625, 6 / 16], [.5, .5], [1]],
                            fourBars: [[7 / 16, 9 / 16, 7 / 16, 9 / 16], [9 / 16, 7 / 16, 9 / 16, 7 / 16], [6 / 16, .625, 6 / 16, .625], [.625, 6 / 16, .625, 6 / 16], [.5, .5, .5, .5], [1, 1]]
                        },
                        this.bassDurations = {
                            twoBars: [[.25, .25, .25, .25], [.5, .5], [6 / 16, .625], [5 / 16, 11 / 16], [7 / 16, 9 / 16], [.625, 6 / 16]],
                            fourBars: [[.25, .25, .25, .25, .25, .25, .25, .25], [.5, .5, .5, .5], [6 / 16, .625, 6 / 16, .625], [5 / 16, 7 / 16, 5 / 16, 7 / 16, 5 / 16, 7 / 16, 5 / 16, 7 / 16], [7 / 16, 9 / 16, 7 / 16, 9 / 16], [.625, 6 / 16, .625, 6 / 16]]
                        },
                        this.melodyDurations = {
                            twoBars: [[2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16], [.25, .25, .25, .25], [.5, .5], [3 / 16, 3 / 16, 3 / 16, 3 / 16, .25], [2 / 16, .25, 2 / 16, .25, 2 / 16, 2 / 16], [6 / 16, 6 / 16, .25]],
                            fourBars: [[2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16, 2 / 16], [.25, .25, .25, .25, .25, .25, .25, .25], [.5, .5, .5, .5], [6 / 16, 6 / 16, .25, .25], [5 / 16, 5 / 16, 6 / 16, 6 / 16, 2 / 16, 2 / 16], [3 / 16, 3 / 16, 3 / 16, 3 / 16, .25, .25, 2 / 16, 2 / 16]]
                        },
                        this.patternDurations = {
                            3: this.durationsCombinations.twoBars,
                            4: this.durationsCombinations.fourBars,
                            5: this.durationsCombinations.fourBars
                        },
                        this.probabilityMappings = {
                            chords: [{
                                position: 0,
                                probability: .9
                            }, {
                                position: 4,
                                probability: .8
                            }, {
                                position: 8,
                                probability: .7
                            }, {
                                position: 12,
                                probability: .6
                            }],
                            melody: [{
                                position: 0,
                                probability: .9
                            }, {
                                position: 2,
                                probability: .8
                            }, {
                                position: 4,
                                probability: .7
                            }, {
                                position: 6,
                                probability: .6
                            }, {
                                position: 8,
                                probability: .7
                            }, {
                                position: 10,
                                probability: .6
                            }, {
                                position: 12,
                                probability: .5
                            }, {
                                position: 14,
                                probability: .4
                            }],
                            beats: [{
                                position: 0,
                                probability: 1
                            }, {
                                position: 4,
                                probability: .8
                            }, {
                                position: 8,
                                probability: 1
                            }, {
                                position: 12,
                                probability: .8
                            }],
                            bass: [{
                                position: 0,
                                probability: .9
                            }, {
                                position: 4,
                                probability: .8
                            }, {
                                position: 8,
                                probability: .7
                            }, {
                                position: 12,
                                probability: .6
                            }]
                        },
                        this.enharmonicMap = {
                            Db: "C#",
                            "D#": "Eb",
                            Gb: "F#",
                            "G#": "Ab",
                            "A#": "Bb"
                        },
                        this.scaleDefinitions = {
                            major: {
                                notes: ["C", "D", "E", "F", "G", "A", "B"],
                                chords: {
                                    I: ["C", "E", "G"],
                                    IV: ["F", "A", "C"],
                                    V: ["G", "B", "D"]
                                },
                                probabilities: {
                                    C: {
                                        G: .5,
                                        Am: .3,
                                        F: .2
                                    },
                                    G: {
                                        Am: .4,
                                        F: .4,
                                        C: .2
                                    },
                                    Am: {
                                        F: .5,
                                        C: .3,
                                        G: .2
                                    },
                                    F: {
                                        C: .6,
                                        G: .3,
                                        Am: .1
                                    }
                                }
                            },
                            minor: {
                                notes: ["C", "D", "D#", "F", "G", "G#", "A#"],
                                chords: {
                                    i: ["C", "D#", "G"],
                                    iv: ["F", "A#", "D#"],
                                    v: ["G", "A#", "D#"]
                                },
                                probabilities: {
                                    C: {
                                        G: .4,
                                        "A#": .6
                                    },
                                    G: {
                                        C: .4,
                                        "D#": .6
                                    },
                                    "A#": {
                                        C: .4,
                                        F: .6
                                    },
                                    "D#": {
                                        G: .5,
                                        "A#": .5
                                    },
                                    F: {
                                        C: .4,
                                        "A#": .6
                                    }
                                }
                            },
                            pentatonicMajor: {
                                notes: ["C", "D", "E", "G", "A"],
                                chords: {
                                    I: ["C", "E", "G"],
                                    IV: ["F", "A", "C"],
                                    V: ["G", "B", "D"]
                                },
                                probabilities: {
                                    C: {
                                        D: .3,
                                        E: .7
                                    },
                                    D: {
                                        E: .5,
                                        G: .5
                                    },
                                    E: {
                                        G: .5,
                                        A: .5
                                    },
                                    G: {
                                        A: .4,
                                        C: .6
                                    },
                                    A: {
                                        C: .7,
                                        D: .3
                                    }
                                }
                            },
                            pentatonicMinor: {
                                notes: ["C", "Eb", "F", "G", "Bb"],
                                chords: {
                                    Cm: ["C", "Eb", "G"],
                                    Fm: ["F", "Bb", "Eb"],
                                    Gm: ["G", "Bb", "C"]
                                },
                                probabilities: {
                                    Cm: {
                                        Fm: .5,
                                        Gm: .5
                                    },
                                    Fm: {
                                        Gm: .6,
                                        Cm: .4
                                    },
                                    Gm: {
                                        Cm: .7,
                                        Fm: .3
                                    }
                                }
                            },
                            blues: {
                                notes: ["C", "Eb", "F", "F#", "G", "Bb"],
                                chords: {
                                    I: ["C", "Eb", "G"],
                                    IV: ["F", "Bb", "C"],
                                    V: ["G", "Bb", "D"]
                                },
                                probabilities: {
                                    C: {
                                        Eb: .4,
                                        G: .6
                                    },
                                    Eb: {
                                        F: .5,
                                        G: .5
                                    },
                                    F: {
                                        "F#": .5,
                                        Bb: .5
                                    },
                                    "F#": {
                                        G: 1
                                    },
                                    G: {
                                        Bb: .8,
                                        C: .2
                                    },
                                    Bb: {
                                        C: 1
                                    }
                                }
                            },
                            harmonicMinor: {
                                notes: ["C", "D", "Eb", "F", "G", "Ab", "B"],
                                chords: {
                                    Cm: ["C", "Eb", "G"],
                                    Daug: ["D", "F#", "B"],
                                    Ebm: ["Eb", "Gb", "Bb"],
                                    Faug: ["F", "A", "C#"],
                                    G: ["G", "B", "D"],
                                    Ab: ["Ab", "C", "Eb"],
                                    Bdim: ["B", "D", "F"]
                                },
                                probabilities: {
                                    Cm: {
                                        Daug: .3,
                                        G: .7
                                    },
                                    Daug: {
                                        Ebm: .5,
                                        Faug: .5
                                    },
                                    Ebm: {
                                        Faug: .5,
                                        G: .5
                                    },
                                    Faug: {
                                        G: .5,
                                        Ab: .5
                                    },
                                    G: {
                                        Ab: .3,
                                        Bdim: .7
                                    },
                                    Ab: {
                                        Bdim: .5,
                                        Cm: .5
                                    },
                                    Bdim: {
                                        Cm: 1
                                    }
                                }
                            },
                            dorian: {
                                notes: ["C", "D", "Eb", "F", "G", "A", "Bb"],
                                chords: {
                                    Cm7: ["C", "Eb", "G", "Bb"],
                                    Dm7: ["D", "F", "A", "C"],
                                    Ebmaj7: ["Eb", "G", "Bb", "D"],
                                    F7: ["F", "A", "C", "Eb"],
                                    Gm7: ["G", "Bb", "D", "F"],
                                    Am7b5: ["A", "C", "Eb", "G"],
                                    Bbmaj7: ["Bb", "D", "F", "A"]
                                },
                                probabilities: {
                                    Cm7: {
                                        Dm7: .4,
                                        Gm7: .6
                                    },
                                    Dm7: {
                                        Ebmaj7: .3,
                                        F7: .7
                                    },
                                    Ebmaj7: {
                                        F7: .4,
                                        Gm7: .6
                                    },
                                    F7: {
                                        Gm7: .6,
                                        Am7b5: .4
                                    },
                                    Gm7: {
                                        Am7b5: .5,
                                        Bbmaj7: .5
                                    },
                                    Am7b5: {
                                        Bbmaj7: .7,
                                        Cm7: .3
                                    },
                                    Bbmaj7: {
                                        Cm7: 1
                                    }
                                }
                            },
                            lydian: {
                                notes: ["C", "D", "E", "F#", "G", "A", "B"],
                                chords: {
                                    "Cmaj7#11": ["C", "E", "G", "B", "F#"],
                                    D6: ["D", "F#", "A", "B"],
                                    Em7: ["E", "G", "B", "D"],
                                    "F#m7": ["F#", "A", "C#", "E"],
                                    Gmaj7: ["G", "B", "D", "F#"],
                                    A7: ["A", "C#", "E", "G"],
                                    Bm7: ["B", "D", "F#", "A"]
                                },
                                probabilities: {
                                    "Cmaj7#11": {
                                        D6: .4,
                                        Gmaj7: .6
                                    },
                                    D6: {
                                        Em7: .3,
                                        "F#m7": .7
                                    },
                                    Em7: {
                                        "F#m7": .4,
                                        Gmaj7: .6
                                    },
                                    "F#m7": {
                                        Gmaj7: .6,
                                        A7: .4
                                    },
                                    Gmaj7: {
                                        A7: .5,
                                        Bm7: .5
                                    },
                                    A7: {
                                        Bm7: .7,
                                        "Cmaj7#11": .3
                                    },
                                    Bm7: {
                                        "Cmaj7#11": 1
                                    }
                                }
                            },
                            mixolydian: {
                                notes: ["C", "D", "E", "F", "G", "A", "Bb"],
                                chords: {
                                    C7: ["C", "E", "G", "Bb"],
                                    Dm: ["D", "F", "A"],
                                    Em7: ["E", "G", "B", "D"],
                                    Fmaj7: ["F", "A", "C", "E"],
                                    Gm7: ["G", "Bb", "D", "F"],
                                    Am7: ["A", "C", "E", "G"],
                                    Bb6: ["Bb", "D", "F", "G"]
                                },
                                probabilities: {
                                    C7: {
                                        Dm: .4,
                                        Gm7: .6
                                    },
                                    Dm: {
                                        Em7: .3,
                                        Fmaj7: .7
                                    },
                                    Em7: {
                                        Fmaj7: .4,
                                        Gm7: .6
                                    },
                                    Fmaj7: {
                                        Gm7: .6,
                                        Am7: .4
                                    },
                                    Gm7: {
                                        Am7: .5,
                                        Bb6: .5
                                    },
                                    Am7: {
                                        Bb6: .7,
                                        C7: .3
                                    },
                                    Bb6: {
                                        C7: 1
                                    }
                                }
                            },
                            phrygian: {
                                notes: ["C", "Db", "Eb", "F", "G", "Ab", "Bb"],
                                chords: {
                                    Cm: ["C", "Eb", "G"],
                                    Dbmaj7: ["Db", "F", "Ab", "C"],
                                    Ebaug: ["Eb", "G", "Bb"],
                                    Fm7: ["F", "Ab", "C", "Eb"],
                                    Gdim: ["G", "Bb", "Db"],
                                    Abmaj7: ["Ab", "C", "Eb", "F"],
                                    Bb7: ["Bb", "Db", "F", "Ab"]
                                },
                                probabilities: {
                                    Cm: {
                                        Dbmaj7: .4,
                                        Fm7: .6
                                    },
                                    Dbmaj7: {
                                        Ebaug: .3,
                                        Gdim: .7
                                    },
                                    Ebaug: {
                                        Fm7: .4,
                                        Abmaj7: .6
                                    },
                                    Fm7: {
                                        Abmaj7: .6,
                                        Bb7: .4
                                    },
                                    Gdim: {
                                        Abmaj7: .5,
                                        Bb7: .5
                                    },
                                    Abmaj7: {
                                        Bb7: .7,
                                        Cm: .3
                                    },
                                    Bb7: {
                                        Cm: 1
                                    }
                                }
                            },
                            locrian: {
                                notes: ["C", "Db", "Eb", "F", "Gb", "Ab", "Bb"],
                                chords: {
                                    Cdim: ["C", "Eb", "Gb"],
                                    Dbm: ["Db", "F", "Ab"],
                                    Ebm7: ["Eb", "Gb", "Bb", "Db"],
                                    Fm7b5: ["F", "Ab", "Bb", "Db"],
                                    Gbmaj7: ["Gb", "Bb", "Db", "F"],
                                    Ab7: ["Ab", "C", "Eb", "Gb"],
                                    Bbm6: ["Bb", "Db", "F", "Gb"]
                                },
                                probabilities: {
                                    Cdim: {
                                        Dbm: .4,
                                        Gbmaj7: .6
                                    },
                                    Dbm: {
                                        Ebm7: .3,
                                        Fm7b5: .7
                                    },
                                    Ebm7: {
                                        Fm7b5: .4,
                                        Ab7: .6
                                    },
                                    Fm7b5: {
                                        Ab7: .6,
                                        Bbm6: .4
                                    },
                                    Gbmaj7: {
                                        Ab7: .5,
                                        Bbm6: .5
                                    },
                                    Ab7: {
                                        Bbm6: .7,
                                        Cdim: .3
                                    },
                                    Bbm6: {
                                        Cdim: 1
                                    }
                                }
                            }
                        },
                        this.styleScaleProbabilities = {
                            pop: {
                                major: .4,
                                minor: .4,
                                pentatonicMajor: .2
                            },
                            rock: {
                                major: .3,
                                minor: .4,
                                pentatonicMinor: .3
                            },
                            blues: {
                                blues: .7,
                                pentatonicMinor: .3
                            },
                            jazz: {
                                dorian: .25,
                                mixolydian: .25,
                                lydian: .25,
                                harmonicMinor: .25
                            },
                            edm: {
                                major: .5,
                                minor: .4,
                                pentatonicMinor: .1
                            },
                            rnb: {
                                minor: .5,
                                harmonicMinor: .2,
                                major: .3
                            },
                            country: {
                                major: .6,
                                pentatonicMajor: .2,
                                mixolydian: .2
                            },
                            reggae: {
                                major: .5,
                                mixolydian: .3,
                                dorian: .2
                            },
                            metal: {
                                minor: .4,
                                harmonicMinor: .4,
                                phrygian: .2
                            },
                            punk: {
                                major: .5,
                                minor: .5
                            },
                            funk: {
                                dorian: .4,
                                mixolydian: .4,
                                minor: .2
                            },
                            disco: {
                                major: .6,
                                pentatonicMinor: .4
                            },
                            latin: {
                                harmonicMinor: .3,
                                phrygian: .3,
                                major: .4
                            },
                            ambient: {
                                major: .5,
                                locrian: .2,
                                phrygian: .3,
                                minor: .5
                            },
                            folk: {
                                major: .6,
                                minor: .2,
                                dorian: .2
                            },
                            trap: {
                                minor: .5,
                                phrygian: .3,
                                harmonicMinor: .2
                            },
                            kpop: {
                                major: .4,
                                minor: .4,
                                pentatonicMajor: .2
                            },
                            gospel: {
                                major: .6,
                                pentatonicMajor: .2,
                                mixolydian: .2
                            },
                            soul: {
                                major: .5,
                                dorian: .3,
                                mixolydian: .2
                            },
                            house: {
                                major: .4,
                                minor: .4,
                                mixolydian: .2
                            },
                            chiptune: {
                                major: .4,
                                minor: .4,
                                pentatonicMajor: .2
                            },
                            hiphop: {
                                minor: .5,
                                dorian: .3,
                                phrygian: .2
                            },
                            rap: {
                                minor: .5,
                                dorian: .3,
                                phrygian: .2
                            }
                        },
                        this.popularKeys = {
                            pop: ["C", "G", "A", "E"],
                            rock: ["E", "A", "D", "G"],
                            blues: ["E", "A", "C", "G"],
                            jazz: ["F", "B♭", "E♭", "A♭"],
                            edm: ["C", "F", "G", "D"],
                            rnb: ["A", "E", "G", "C"],
                            country: ["G", "D", "A", "C"],
                            reggae: ["A", "G", "D", "E"],
                            metal: ["E", "A", "D", "G"],
                            punk: ["A", "E", "G", "D"],
                            funk: ["E", "A", "G", "D"],
                            disco: ["C", "F", "G", "D"],
                            latin: ["C", "F", "G", "D"],
                            ambient: ["C", "G", "D", "A"],
                            folk: ["G", "C", "D", "A"],
                            trap: ["A", "E", "G", "C"],
                            kpop: ["G", "D", "A", "E"],
                            gospel: ["C", "F", "G", "A"],
                            soul: ["A", "E", "G", "C"],
                            house: ["C", "F", "G", "D"],
                            chiptune: ["C", "G", "A", "E"],
                            hiphop: ["A", "E", "G", "C"],
                            rap: ["A", "E", "G", "C"]
                        },
                        this.beatProbabilities = {
                            hiphop: {
                                kick: [1, .2, 0, .8, 0, .6, 0, .3, 1, .2, 0, .8, 0, .6, 0, .3],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.7, .8, .7, .9, 1, .7, 1, 1, .8, 1, .7, 1, 1, .7, 1, 1],
                                openhat: [0, 0, 0, 0, .8, 0, 0, 0, 0, 0, 0, 0, .8, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, .7, 0, 0, 0, 0, 0, 0, 0],
                                crash: [.7, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, .5, .8, 0, .9, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, .6, 0, .6, 0, 0, 0, 0, 0, .6, 0, .6],
                                bpmRange: [85, 95]
                            },
                            rap: {
                                kick: [1, .3, 0, .3, 1, .2, 0, 1, .3, 0, 0, 1, .3, 0, 1, 0],
                                snare: [0, 0, 1, 0, 0, .2, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [1, 1, 1, 1, .9, 1, .9, 1, 1, .9, 1, 1, 1, .9, 1, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0],
                                clap: [0, 0, 1, 0, 0, 0, .7, 0, 0, 0, 1, 0, 0, 0, .7, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, .8, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, .5, .7, 0, .7, 0, 1, 0, .8],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                                bpmRange: [75, 115]
                            },
                            chiptune: {
                                kick: [1, 0, 0, .4, 1, 0, 0, .4, 1, 0, 0, .4, 1, 0, 0, .4],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [1, .2, 1, .3, 1, .2, 1, .3, 1, .2, 1, .3, 1, .2, 1, .3],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, .8],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, .7, 0, 0, 0, 0, 0, 0, 0, .7, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 140]
                            },
                            edm: {
                                kick: [1, 0, 0, .6, 1, 0, 0, .6, 1, 0, 0, .6, 1, 0, 0, .6],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.6, .8, .6, .8, .6, .8, .6, .8, .6, .8, .6, .8, .6, .8, .6, .8],
                                openhat: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
                                clap: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                crash: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                                bpmRange: [120, 150]
                            },
                            pop: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 130]
                            },
                            rock: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [110, 140]
                            },
                            blues: {
                                kick: [1, 0, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1],
                                openhat: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1],
                                bpmRange: [60, 90]
                            },
                            jazz: {
                                kick: [.5, 0, .5, 0, .5, 0, .5, 0, .5, 0, .5, 0, .5, 0, .5, 0],
                                snare: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                                openhat: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [120, 160]
                            },
                            rnb: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1],
                                openhat: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1],
                                bpmRange: [60, 80]
                            },
                            country: {
                                kick: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                                snare: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
                                hihat: [.5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [110, 130]
                            },
                            reggae: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
                                hihat: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                                openhat: [0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [70, 90]
                            },
                            metal: {
                                kick: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                                snare: [0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1],
                                hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 180]
                            },
                            punk: {
                                kick: [1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0],
                                snare: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [130, 180]
                            },
                            funk: {
                                kick: [1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0],
                                snare: [0, 0, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1],
                                hihat: [.7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1, .7, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                                clap: [0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [90, 120]
                            },
                            disco: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [120, 130]
                            },
                            latin: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 130]
                            },
                            ambient: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                hihat: [.5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5, .5],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [60, 90]
                            },
                            folk: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 130]
                            },
                            trap: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1],
                                clap: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1],
                                bpmRange: [70, 110]
                            },
                            kpop: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [90, 130]
                            },
                            gospel: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [90, 120]
                            },
                            soul: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [100, 120]
                            },
                            house: {
                                kick: [1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0],
                                snare: [0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0],
                                hihat: [.5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1, .5, 1],
                                openhat: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                clap: [0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0],
                                crash: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                perc: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                tom: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
                                bpmRange: [120, 130]
                            }
                        },
                        this.keys = [{
                            name: "C",
                            transpose: 0
                        }, {
                            name: "C#",
                            transpose: 1
                        }, {
                            name: "Db",
                            transpose: 1
                        }, {
                            name: "D",
                            transpose: 2
                        }, {
                            name: "D#",
                            transpose: 3
                        }, {
                            name: "Eb",
                            transpose: 3
                        }, {
                            name: "E",
                            transpose: 4
                        }, {
                            name: "F",
                            transpose: 5
                        }, {
                            name: "F#",
                            transpose: 6
                        }, {
                            name: "Gb",
                            transpose: 6
                        }, {
                            name: "G",
                            transpose: 7
                        }, {
                            name: "G#",
                            transpose: 8
                        }, {
                            name: "Ab",
                            transpose: 8
                        }, {
                            name: "A",
                            transpose: 9
                        }, {
                            name: "A#",
                            transpose: 10
                        }, {
                            name: "Bb",
                            transpose: 10
                        }, {
                            name: "B",
                            transpose: 11
                        }],
                        this.availableModes = ["major", "minor", "dorian", "phrygian", "lydian", "mixolydian", "locrian"],
                        this.elements = ["kick", "snare", "hihat", "openhat", "clap", "crash", "perc", "tom"],
                        this.notes = this.defineNotes(),
                        this.chords = this.defineChords(),
                        this.bpm = this.setBPM(),
                        this.mode = this.pickRandomMode()
                    }
                    pickRandomMode() {
                        let $ = getaudioPart("mode");
                        return -1 == $ && ($ = Math.floor(seededRandom.random() * this.availableModes.length)),
                        this.availableModes[$]
                    }
                    selectScaleForStyle() {
                        let $ = this.styleScaleProbabilities[this.style]
                          , e = seededRandom.random()
                          , i = 0;
                        for (let[t,a] of Object.entries($))
                            if (e < (i += a))
                                return t;
                        return null
                    }
                    setBPM() {
                        return seededRandom.random(),
                        this.beatProbabilities.length,
                        this.beatPattern = this.beatProbabilities[this.style],
                        Math.floor(seededRandom.random() * (this.beatPattern.bpmRange[1] - this.beatPattern.bpmRange[0] + 1)) + this.beatPattern.bpmRange[0]
                    }
                    getTransposedScale($) {
                        let e = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"]
                          , i = {
                            Db: "C#",
                            "D#": "Eb",
                            Gb: "F#",
                            "G#": "Ab",
                            "A#": "Bb"
                        };
                        return e.map(t=>{
                            let a = t;
                            i[t] && (a = i[t]);
                            let n = e.indexOf(a)
                              , o = (n + $ + e.length) % e.length;
                            return e[o]
                        }
                        )
                    }
                    pickRandomPattern($) {
                        let e = ["3", "4", "5"]
                          , i = e[Math.floor(seededRandom.random() * e.length)]
                          , t = this.chordPatterns[`${$}${i}`];
                        return t[Math.floor(seededRandom.random() * t.length)]
                    }
                    defineNotes() {
                        return ({
                            major: ["C", "D", "E", "F", "G", "A", "B"],
                            minor: ["C", "D", "Eb", "F", "G", "Ab", "Bb"],
                            blues: ["C", "Eb", "F", "Gb", "G", "Bb"],
                            pentatonicMajor: ["C", "D", "E", "G", "A"],
                            pentatonicMinor: ["C", "Eb", "F", "G", "Bb"],
                            harmonicMinor: ["C", "D", "Eb", "F", "G", "Ab", "B"],
                            melodicMinorAsc: ["C", "D", "Eb", "F", "G", "A", "B"],
                            dorian: ["C", "D", "Eb", "F", "G", "A", "Bb"],
                            lydian: ["C", "D", "E", "F#", "G", "A", "B"],
                            mixolydian: ["C", "D", "E", "F", "G", "A", "Bb"],
                            phrygian: ["C", "Db", "Eb", "F", "G", "Ab", "Bb"],
                            locrian: ["C", "Db", "Eb", "F", "Gb", "Ab", "Bb"]
                        })[this.scale] || []
                    }
                    defineChords() {
                        return ({
                            major: ["Cmaj", "Dmin", "Emin", "Fmaj", "Gmaj", "Amin", "Bdim"],
                            minor: ["Cmin", "Ddim", "Ebaug", "Fmin", "Gmin", "Abmaj", "Bbmaj"],
                            blues: ["C7", "F7", "G7"],
                            pentatonicMajor: ["Cmaj", "Dmin", "Emin", "Gmaj", "Amin"],
                            pentatonicMinor: ["Cmin", "Ebaug", "Fmin", "Gmin", "Bbmin"],
                            harmonicMinor: ["CminMaj7", "Dmin7b5", "EbaugMaj7", "Fmin7", "G7", "Abmaj7", "Bdim7"],
                            melodicMinorAsc: ["CminMaj7", "Dmin7", "EbaugMaj7", "Fmaj7", "G7", "Amin7b5", "Bmin7b5"],
                            dorian: ["Cmin7", "Dmin7", "Ebmaj7", "F7", "Gmin7", "Amin7b5", "Bb7"],
                            lydian: ["Cmaj7#11", "Dmaj7#11", "Emaj7#11", "F#7", "Gmaj7#11", "Amaj7#11", "Bmaj7#11"],
                            mixolydian: ["C7", "Dmin7", "Emin7", "Fmaj7", "G7", "Amin7", "Bb7"],
                            phrygian: ["Cmin7", "Dbmaj7", "Eb7", "Fmin7", "Gmin7b5", "Abmaj7", "Bb7"],
                            locrian: ["Cdim7", "Dbmin7b5", "Ebmin7b5", "Fdim", "Gbmin7b5", "Abmin7b5", "Bb7"]
                        })[this.scale] || []
                    }
                    getChordsForStyle() {
                        return ({
                            pop: ["I", "V", "vi", "IV"],
                            rock: ["I", "IV", "V"],
                            blues: ["I7", "IV7", "V7"],
                            jazz: ["IIm7", "V7", "Imaj7", "IVmaj7"],
                            edm: ["I", "vi", "IV", "V"],
                            rnb: ["Im7", "IVm7", "VIm7", "Vm7"],
                            country: ["I", "IV", "I", "V"],
                            reggae: ["I", "IV", "V", "IV"],
                            metal: ["i", "iv", "V", "i"],
                            punk: ["I", "V", "IV", "I"],
                            funk: ["I7", "IV7", "I7", "IV7"],
                            disco: ["I", "IV", "vi", "V"],
                            latin: ["I", "IV", "ii", "V"],
                            ambient: ["I", "ii", "iii", "IV"],
                            folk: ["I", "IV", "V", "IV"],
                            trap: ["i", "VII", "VI", "v"],
                            kpop: ["I", "V", "iii", "vi"],
                            gospel: ["I", "IV", "I", "V"],
                            soul: ["I7", "IV7", "ii", "V7"],
                            house: ["I", "I", "V", "IV"],
                            hiphop: ["I", "vi", "IV", "V"],
                            rap: ["i", "iv", "VII", "III"],
                            chiptune: ["I", "IV", "V", "I"]
                        })[this.style].map($=>this.translateChord($))
                    }
                    getNotesForBass() {
                        return ({
                            pop: ["I", "V", "vi", "IV"],
                            rock: ["I", "IV", "V"],
                            blues: ["I", "IV", "I", "V"],
                            jazz: ["ii", "V", "I", "IV"],
                            edm: ["I", "vi", "IV", "V"],
                            rnb: ["I", "IV", "VI", "V"],
                            country: ["I", "IV", "I", "V"],
                            reggae: ["I", "IV", "V", "IV"],
                            metal: ["i", "iv", "V", "i"],
                            punk: ["I", "V", "IV", "I"],
                            funk: ["I", "IV", "I", "IV"],
                            disco: ["I", "IV", "vi", "V"],
                            latin: ["I", "IV", "ii", "V"],
                            ambient: ["I", "ii", "iii", "IV"],
                            folk: ["I", "IV", "V", "IV"],
                            trap: ["i", "VII", "VI", "v"],
                            kpop: ["I", "V", "iii", "vi"],
                            gospel: ["I", "IV", "I", "V"],
                            soul: ["I", "IV", "ii", "V"],
                            house: ["I", "I", "V", "IV"],
                            hiphop: ["I", "vi", "IV", "V"],
                            rap: ["i", "iv", "VII", "III"],
                            chiptune: ["I", "V", "IV", "I"]
                        })[this.style].map($=>this.translateBass($))
                    }
                    translateChord($) {
                        let e = this.romanToInt($);
                        return this.chords[e % this.chords.length]
                    }
                    translateBass($) {
                        let e = this.romanToInt($);
                        return this.notes[e % this.notes.length]
                    }
                    romanToInt($) {
                        return ({
                            I: 0,
                            II: 1,
                            III: 2,
                            IV: 3,
                            V: 4,
                            VI: 5,
                            VII: 6,
                            i: 0,
                            ii: 1,
                            iii: 2,
                            iv: 3,
                            v: 4,
                            vi: 5,
                            vii: 6
                        })[$.toUpperCase()] || 0
                    }
                    getNoteDurationInBeats($) {
                        switch ($) {
                        case "1n":
                            return 4;
                        case "2n":
                            return 2;
                        case "4n":
                        default:
                            return 1;
                        case "8n":
                            return .5;
                        case "16n":
                            return .25
                        }
                    }
                    pickRandomModeAndPattern() {
                        let $ = ["major", "minor", "mixolydian", "dorian", "lydian", "phrygian", "locrian"]
                          , e = ["3", "4", "5"]
                          , i = $[Math.floor(seededRandom.random() * $.length)]
                          , t = e[Math.floor(seededRandom.random() * e.length)]
                          , a = `${i}${t}`;
                        return a
                    }
                    getRandomNoteDuration($) {
                        let e = this.styleNoteDurations[this.style][$]
                          , i = 0;
                        for (let t in e)
                            i += e[t];
                        let a = seededRandom.random() * i;
                        for (let n in e)
                            if ((a -= e[n]) <= 0)
                                return n;
                        return "4n"
                    }
                    getRandomOctave($) {
                        let e = this.octaveProbabilities[$]
                          , i = Object.values(e).reduce(($,e)=>$ + e, 0)
                          , t = seededRandom.random() * i;
                        for (let a in e)
                            if ((t -= e[a]) < 0)
                                return parseInt(a);
                        return 2
                    }
                    getNextElement($, e, i) {
                        let t = this.getRandomOctave(i)
                          , a = e.reduce(($,e)=>$ + e, 0)
                          , n = seededRandom.random() * a;
                        for (let o = 0; o < $.length; o++)
                            if ((n -= e[o]) <= 0) {
                                let r = $[o];
                                if (Array.isArray(r))
                                    return r.map($=>({
                                        note: $,
                                        octave: t
                                    }));
                                return {
                                    note: r,
                                    octave: t
                                }
                            }
                        let s = $[0];
                        return Array.isArray(s) ? s.map($=>({
                            note: $,
                            octave: t
                        })) : {
                            note: s,
                            octave: t
                        }
                    }
                    generateRiff($=this.style, e) {
                        let i = this.selectKey($)
                          , t = this.riffPatterns[$][e];
                        return this.transposeRiff(t, i, e)
                    }
                    selectKey($) {
                        let e = this.popularKeys[$];
                        return e[Math.floor(seededRandom.random() * e.length)]
                    }
                    transposeRiff($, e, i) {
                        let t = this.scaleDefinitions[i].notes
                          , a = this.getScale(e, i)
                          , n = JSON.parse(JSON.stringify($));
                        return n.melody.forEach($=>{
                            $.riff = $.riff.map($=>this.transposeNoteToKey($, t, a))
                        }
                        ),
                        n.chords.forEach($=>{
                            $.riff = $.riff.map($=>$.map($=>this.transposeNoteToKey($, t, a)))
                        }
                        ),
                        n.bassline.forEach($=>{
                            $.riff = $.riff.map($=>this.transposeNoteToKey($, t, a))
                        }
                        ),
                        n
                    }
                    transposeNoteToKey($, e, i) {
                        let t = $.note
                          , a = $.octave
                          , n = this.scaleDefinitions[i].notes
                          , o = n.indexOf(t);
                        if (-1 === o)
                            return console.error(`Note ${t} not found in scale ${i}`),
                            {
                                note: t,
                                octave: a
                            };
                        let r = e[o];
                        return {
                            note: r,
                            octave: a
                        }
                    }
                    generateVerse($) {
                        let e = []
                          , i = 0;
                        for (; i < 8; ) {
                            let t = .25 > seededRandom.random()
                              , a = [];
                            for (let n of (t && i <= 4 && a.push(this.pickRandomPattern($)),
                            a.push(this.pickRandomPattern($)),
                            a)) {
                                let o = n.length
                                  , r = this.patternDurations[o][Math.floor(seededRandom.random() * this.patternDurations[o].length)];
                                for (let s = 0; s < n.length; s++)
                                    e.push({
                                        chord: n[s],
                                        duration: r[s % r.length]
                                    });
                                i += o <= 4 ? 2 : 4
                            }
                        }
                        return e.slice(0, 8)
                    }
                    getScale($, e) {
                        let i = this.scaleDefinitions[e].notes
                          , t = i.indexOf($);
                        if (-1 === t)
                            return console.error(`Key ${$} not found in scale ${e}`),
                            i;
                        let a = (t - i.indexOf("C") + i.length) % i.length
                          , n = i.map(($,e)=>i[(e + a) % i.length]);
                        return n
                    }
                    generateBeatPattern($) {
                        let e = {};
                        for (let i in $)
                            "bpmRange" !== i && (e[i] = $[i].map(($,e)=>({
                                pattern: $ >= seededRandom.random(),
                                duration: "16n",
                                index: e
                            })).filter($=>$.pattern));
                        return e
                    }
                    generateBeat() {
                        let $ = {};
                        return Object.keys(this.beatProbabilities[this.style]).forEach(e=>{
                            "bpmRange" !== e && ($[e] = this.beatProbabilities[this.style][e].map($=>seededRandom.random() < $ ? "x" : ""))
                        }
                        ),
                        $
                    }
                    getNearestScaleNote($, e) {
                        let i = {
                            C: 0,
                            "C#": 1,
                            Db: 1,
                            D: 2,
                            "D#": 3,
                            Eb: 3,
                            E: 4,
                            F: 5,
                            "F#": 6,
                            Gb: 6,
                            G: 7,
                            "G#": 8,
                            Ab: 8,
                            A: 9,
                            "A#": 10,
                            Bb: 10,
                            B: 11
                        };
                        e.map($=>i[$]);
                        let t = i[$]
                          , a = e[0]
                          , n = Math.abs(i[a] - t);
                        for (let o of e) {
                            let r = Math.abs(i[o] - t);
                            r < n && (n = r,
                            a = o)
                        }
                        return a
                    }
                    getPassingNotes($, e) {
                        let i = this.scaleDefinitions[e].notes
                          , t = $.map($=>i.includes($) ? $ : (this.getNearestScaleNote($, i)))
                          , a = [];
                        for (let n = 0; n < t.length - 1; n++) {
                            let o = t[n]
                              , r = t[n + 1]
                              , s = i.indexOf(o)
                              , I = i.indexOf(r);
                            if (-1 === s || -1 === I)
                                continue;
                            let l = I - s;
                            if (l > 1)
                                for (let _ = 1; _ < l; _++)
                                    a.push(i[(s + _) % i.length]);
                            else if (l < -1)
                                for (let m = 1; m < Math.abs(l); m++)
                                    a.push(i[(s - m + i.length) % i.length])
                        }
                        return a
                    }
                    getBassNoteFromChord($, e) {
                        let i = $
                          , t = this.getPassingNotes(i, e)
                          , a = [...i, ...t];
                        return a[Math.floor(seededRandom.random() * a.length)]
                    }
                    getMelodyNoteFromChord($, e) {
                        let i = $
                          , t = this.getPassingNotes(i, e)
                          , a = [...i, ...t];
                        return a[Math.floor(seededRandom.random() * a.length)]
                    }
                    preloadNextMelody($) {}
                    preloadNextBassline($) {}
                    generatePattern($, e) {
                        let i = Array(GRID_SIZE).fill(null);
                        if ("beats" === $)
                            return this.generateBeatPattern(e);
                        for (let {position: t, probability: a} of this.probabilityMappings[$])
                            if (seededRandom.random() < a) {
                                let n = this.selectPattern(e)
                                  , o = this.getRandomNoteDuration($);
                                i[t] = {
                                    pattern: n,
                                    duration: o
                                }
                            }
                        return i
                    }
                    selectPattern($) {
                        let e = $.reduce(($,{probability: e})=>$ + e, 0)
                          , i = seededRandom.random() * e;
                        for (let {riff: t, probability: a} of $)
                            if ((i -= a) <= 0)
                                return t;
                        return $[0].riff
                    }
                    preloadNextChords($) {
                        this.nextChords = this.generateChords($)
                    }
                    generateMelody($, e) {
                        if ($ <= 0)
                            return [];
                        let i = this.riffPatterns[this.style][this.scale].melody;
                        if (!i || 0 === i.length)
                            return console.error("Invalid melody riff pattern:", i),
                            [];
                        let t = i[Math.floor(seededRandom.random() * i.length)];
                        if (!t || !t.riff || !t.probabilities)
                            return console.error("Invalid riff structure:", t),
                            [];
                        let a = [];
                        for (let n = 0; n < $; n++)
                            a.push(this.getNextElement(t.riff, t.probabilities, "melody"));
                        let o = []
                          , r = 0
                          , s = ["4n", "8n", "16n"];
                        for (let I = 0; I < 4 * $; I++) {
                            let l = 0;
                            for (; l < 4; ) {
                                let _ = this.getNextElement(t.riff, t.probabilities, "melody")
                                  , m = s[Math.floor(seededRandom.random() * s.length)]
                                  , h = this.getNoteDurationInBeats(m);
                                if (l + h <= 4) {
                                    let d = .5 > seededRandom.random() ? 3 : 4;
                                    o.push({
                                        note: _.note,
                                        octave: d,
                                        duration: m
                                    }),
                                    l += h,
                                    r += h
                                }
                            }
                        }
                        return o
                    }
                    generateBassline($, e) {
                        if ($ <= 0)
                            return [];
                        let i = this.riffPatterns[this.style][this.scale].bassline;
                        if (!i || 0 === i.length)
                            return [];
                        let t = i[Math.floor(seededRandom.random() * i.length)];
                        if (!t || !t.riff || !t.probabilities)
                            return [];
                        let a = [];
                        for (let n = 0; n < $; n++)
                            a.push(this.getNextElement(t.riff, t.probabilities, "bassline"));
                        let o = []
                          , r = ["1n", "2n", "4n", "8n", "16n"];
                        for (let s = 0; s < 4 * $; s++) {
                            let I = a[s % a.length];
                            if (I && I.note) {
                                let l = r[Math.floor(seededRandom.random() * r.length)];
                                this.getRandomOctave("bassline");
                                let _ = e[s % e.length].note;
                                o.push({
                                    note: _,
                                    octave: 2,
                                    duration: l
                                })
                            }
                        }
                        return o
                    }
                    generateChords($, e, i) {
                        if ($ <= 0)
                            return [];
                        let t = this.riffPatterns[this.style][this.scale].chords;
                        if (!t || 0 === t.length)
                            return [];
                        let a = t[Math.floor(seededRandom.random() * t.length)];
                        if (!a || !a.riff || !a.probabilities)
                            return [];
                        let n = [];
                        for (let o = 0; o < $; o++) {
                            let r = this.getNextElement(a.riff, a.probabilities, "chords");
                            r && Array.isArray(r) && n.push(r)
                        }
                        let s = []
                          , I = ["1n", "2n", "4n"];
                        for (let l = 0; l < 4 * $; l++) {
                            let _ = e[l % e.length]
                              , m = i[l % i.length]
                              , h = this.getChordFromMelodyAndBass(_, m);
                            if (h.length > 0) {
                                let d = I[Math.floor(seededRandom.random() * I.length)];
                                s.push({
                                    notes: h,
                                    duration: d
                                })
                            }
                        }
                        return s
                    }
                    getChordFromPattern($, e) {
                        let i = $[Math.floor(seededRandom.random() * $.length)];
                        if (!i || !Array.isArray(i.riff) || !Array.isArray(i.probabilities))
                            throw Error("Invalid chord set found in pattern.");
                        let t = i.riff
                          , a = i.probabilities
                          , n = this.selectRandomIndex(a)
                          , o = t[n];
                        return o.map($=>({
                            note: $,
                            octave: 3
                        }))
                    }
                    selectRandomIndex($) {
                        let e = [];
                        for (let i = 0; i < $.length; i++)
                            e[i] = $[i] + (e[i - 1] || 0);
                        let t = seddedRandom.random() * e[e.length - 1];
                        return e.findIndex($=>t < $)
                    }
                    adjustChordForMelody($, e) {
                        return $.some($=>$.note === e.note) || ($[0].note = e.note,
                        $[0].octave = e.octave),
                        $
                    }
                    getNoteFromPattern($, e) {
                        if (!$ || !$.riff || !$.probabilities)
                            return null;
                        let i = $.riff
                          , t = $.probabilities
                          , a = e % i.length;
                        return i[a] ? {
                            note: i[a],
                            probability: t[a]
                        } : null
                    }
                    getChordFromMelodyAndBass($, e) {
                        let i = []
                          , t = e.note
                          , a = this.getThirdNoteFromScale(t)
                          , n = this.getFifthNoteFromScale(t)
                          , o = 4;
                        return $.octave >= 4 && (o = 3),
                        t && i.push({
                            note: t,
                            octave: o
                        }),
                        a && i.push({
                            note: a,
                            octave: o
                        }),
                        n && i.push({
                            note: n,
                            octave: o
                        }),
                        this.getSeventhNoteFromScale(t),
                        i
                    }
                    getThirdNoteFromScale($) {
                        let e = this.scaleDefinitions[this.scale].notes
                          , i = e.indexOf($)
                          , t = (i + 2) % e.length;
                        return e[t]
                    }
                    getFifthNoteFromScale($) {
                        let e = this.scaleDefinitions[this.scale].notes
                          , i = e.indexOf($)
                          , t = (i + 4) % e.length;
                        return e[t]
                    }
                    getSeventhNoteFromScale($) {
                        let e = this.scaleDefinitions[this.scale].notes
                          , i = e.indexOf($)
                          , t = (i + 6) % e.length;
                        return e[t]
                    }
                    selectPattern($) {
                        let e = $.reduce(($,{probability: e})=>$ + e, 0)
                          , i = seededRandom.random() * e;
                        for (let {riff: t, probability: a} of $)
                            if ((i -= a) <= 0)
                                return t;
                        return $[0].riff
                    }
                }
                class LSystem {
                    constructor($, e, i) {
                        this.axiom = $,
                        this.rules = e,
                        this.iterations = i
                    }
                    generate() {
                        let $ = this.axiom;
                        for (let e = 0; e < this.iterations; e++)
                            $ = $.split("").map($=>this.rules[$] || $).join("");
                        return $
                    }
                }
       

                //document.addEventListener("DOMContentLoaded", function() {
                    let $ = document.getElementById("begin")
                      , e = document.getElementById("canvasContainer")
                      , i = document.getElementById("overlay");
                    var t = document.getElementById("blocksCanvas").transferControlToOffscreen()
                      , a = document.getElementById("artCanvas").transferControlToOffscreen()
                      , n = document.getElementById("textCanvas").transferControlToOffscreen();
                    document.body.style.visibility = "visible",
                    seededRandom.random(),
                    seededRandom.random();
                    let o = ["rap", "hiphop", "pop", "rock", "blues", "jazz", "edm", "rnb", "country", "reggae", "metal", "punk", "funk", "disco", "latin", "ambient", "folk", "trap", "kpop", "gospel", "soul", "house", "chiptune"];
                    seededRandom.random();
                    let r = ["C", "C#", "D", "Eb", "E", "F", "F#", "G", "Ab", "A", "Bb", "B"]
                      , s = getaudioPart("style");
                    -1 == s && (s = Math.floor(seededRandom.random() * o.length));
                    let I = getaudioPart("key");
                    -1 == I && (I = r[Math.floor(seededRandom.random() * r.length)]);
                    let l = new SongGenerator(o[s],I)
                      , _ = " "
                      , m = Math.floor(10 * seededRandom.random());
                    let sp = getaudioPart("spiral");
                    -1 == sp && (sp = Math.floor(8 * seededRandom.random()));
                    for (let h = 0; h < Math.floor(5 + 15 * seededRandom.random()); h++)
                        _ += getRandomCharacter(m);
                    let d, b;
                    performance.now(),
                    seededRandom.random(),
                    seededRandom.random(),
                    seededRandom.random(),
                    parseInt(4 * l.scale.bpm);
                    const V = new Worker('newworker.js');
                    function p() {
                        d = window.innerWidth;// * window.devicePixelRatio,
                        b = window.innerHeight;// * window.devicePixelRatio
                    }
                    Promise.all([document.fonts.load('10pt "xoblk"'), document.fonts.load('10pt "xoxb"'), document.fonts.load('10pt "xoend"')]).then(function() {
                        document.body.style.visibility = "visible",
                        p();
                        let e = {
                            command: "glitched",
                            canvas: t,
                            artCanvas: a,
                            textCanvas: n,
                            bpm: l.scale.bpm,
                            seededRandomSeed: seededRandom.seed,
                            width: d,
                            height: b,
                            fonts: fontBlobs,
                            spiral: sp
                        };
                        V.postMessage(e, [t, a, n])
                    }).catch(function($) {
                        console.error("Font failed to load", $)
                    }),
                    $.addEventListener("click", async function() {
                        if (this.classList.contains("enabled"))
                            try {
                                $.innerHTML = "<span>BLOX</span> LOADED",
                                await Tone.start(),
                                Tone.setContext(new Tone.Context({
                                    latencyHint: "playback"
                                })),
                                i.style.display = "none",
                                V.postMessage({
                                    command: "begin"
                                }),
                                l.startMusic(),
                                Tone.Transport.start()
                            } catch (e) {
                                console.error("Error starting AudioContext:", e)
                            }
                    }),
                    V.onmessage = function($) {
    let {command: i, data: t} = $.data;
    if (i === "updateBackground") {
        e.style.backgroundColor = t;
        document.body.style.backgroundColor = t;
    } else if (i === "workerReady") {
        const beginButton = document.getElementById('begin');
        beginButton.disabled = false;
        beginButton.classList.add("enabled");
        beginButton.innerHTML = "START <span>BLXWCO</span>";
    } else if (i === "resetTrack") {
        l.initialized = false;
        l.verse = null;
        l.chorus = null;
        l.prechorus = null;
        l.bridge = null;
        l.outro = null;
        l.intro = null;
        l.songParts = null;
        l.song = null;
        l.initSongParts();
        l.stopSong();
        l.startMusic();
        Tone.Transport.start();
    } else {
        console.log("Unknown command received:", i);
    }
}

                    ,
                    window.addEventListener("resize", p),
                    document.addEventListener("fullscreenchange", p)
                //});
                     });
    </script>
</body>
</html>
